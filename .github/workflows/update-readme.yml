name: ðŸ› ï¸ Update README Stats

on:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Build README Sections
        shell: bash
        run: |
          export LANG=en_US.UTF-8
          export LC_ALL=en_US.UTF-8

          EASY=$(find easy -type f 2>/dev/null | wc -l)
          MEDIUM=$(find medium -type f 2>/dev/null | wc -l)
          HARD=$(find hard -type f 2>/dev/null | wc -l)
          TOTAL=$((EASY + MEDIUM + HARD))
          LANGS=$(find easy medium hard -type f 2>/dev/null | sed 's/.*\.//' | sort -u | wc -l)

          GOAL=150
          PERCENT=$((TOTAL * 100 / GOAL))
          DONE_BLOCKS=$((PERCENT / 5))
          EMPTY_BLOCKS=$((20 - DONE_BLOCKS))
          BAR=$(printf "%${DONE_BLOCKS}s" | tr ' ' 'â–“')$(printf "%${EMPTY_BLOCKS}s" | tr ' ' 'â–‘')

          printf "%s\n" \
          "<!-- STATS_START -->" \
          "## ðŸ“Š Stats" \
          "- ðŸ”¢ Problems Solved: $TOTAL / $GOAL" \
          "  - ðŸŸ¢ Easy: $EASY" \
          "  - ðŸŸ  Medium: $MEDIUM" \
          "  - ðŸ”´ Hard: $HARD" \
          "- ðŸ§© Languages: $LANGS" \
          "- ðŸŽ¯ Goal: Top 150 LeetCode Problems" \
          "  - $BAR $TOTAL/$GOAL (${PERCENT}%)" \
          "<!-- STATS_END -->" > stats_section.md

          printf "%s\n" \
          "<!-- TRACKER_START -->" \
          "## ðŸ“… Progress Tracker" \
          "| # | Title | Difficulty | Language | Status |" \
          "|---|-------|------------|----------|--------|" > tracker_section.md

          for f in $(find easy medium hard -type f); do
            NUM=$(echo $f | sed -E 's/.*\/([0-9]+)-.*/\1/')
            TITLE=$(echo $f | sed -E 's/.*\/[0-9]+-([a-z0-9\-]+)\..*/\1/' | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')
            DIFFICULTY=$(echo $f | cut -d/ -f1 | tr '[:lower:]' '[:upper:]')
            LANG=$(echo $f | awk -F. '{print $NF}' | tr '[:lower:]' '[:upper:]')
            printf "| %s | %s | %s | %s | âœ… |\n" "$NUM" "$TITLE" "$DIFFICULTY" "$LANG" >> tracker_section.md
          done

          echo "<!-- TRACKER_END -->" >> tracker_section.md

      - name: Update README.md using Perl (UTF-8 safe)
        run: |
          perl -0777 -i -pe '
            s/<!-- STATS_START -->.*?<!-- STATS_END -->/`cat stats_section.md`/se;
            s/<!-- TRACKER_START -->.*?<!-- TRACKER_END -->/`cat tracker_section.md`/se;
          ' README.md

      - name: Commit and Push
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add README.md
          git commit -m "ðŸ§® Auto-update stats/tracker (UTF-8 safe using perl)"
          git push
